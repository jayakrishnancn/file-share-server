<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>File Upload</title>
  <style>
    :root {
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --border-color: #ddd;
      --text-color: #111;
      --text-muted: #666;
      --bg-hover: #f8f9fa;
      --bg-main: #f9f9f9;
      --preview-bg: #d73a1a;
      --border-radius: 4px;
      --shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      --transition: 0.3s ease;
    }

    /* Reset and base styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: monospace;
      background: var(--bg-main);
      min-height: 100vh;
      height: 100vh;
      width: 100vw;
      overflow: auto;
    }

    /* Layout components */
    .upload-section {
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border-right: 1px solid var(--border-color);
      position: relative;
      min-height: 100vh;
    }

    /* Toggle button */
    .history-toggle {
      position: fixed;
      right: 25px;
      top: 10px;
      width: 40px;
      height: 36px;
      padding: 0;
      background: #444;
      color: white;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      cursor: pointer;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform var(--transition);
    }

    /* Container and history section */
    .container {
      display: block;
      position: relative;
      overflow: hidden;
    }

    .history-section {
      position: fixed;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      max-width: 400px;
      padding: 20px;
      background: white;
      transform: translateX(100%);
      transition: transform var(--transition);
      box-shadow: -4px -4px 7px 0px #e0e0e0;
      overflow-y: auto;
    }

    .container.show-history .history-section {
      transform: translateX(0);
    }


    /* History panel states */
    .container.show-history .history-toggle svg {
      transform: rotate(180deg);
    }

    /* Overlay for drag and drop */
    .drop-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 123, 255, 0.1);
      border: 2px dashed var(--primary-color);
      z-index: 1000;
      pointer-events: none;
      display: none;
    }

    .drop-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: var(--primary-color);
    }

    /* History section components */
    .history-section h2 {
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .history-item {
      padding: 10px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background var(--transition);
    }

    .history-item:hover {
      background: var(--bg-hover);
    }

    /* History item components */
    .history-item img,
    .history-ext-preview {
      width: 42px;
      height: 42px;
      border-radius: var(--border-radius);
      border: 2px solid var(--text-color);
    }

    .history-item img {
      object-fit: cover;
    }

    .history-item-info {
      flex: 1;
      min-width: 0;
    }

    .history-item-name {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-item-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Action buttons */
    .history-item-actions {
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity var(--transition);
    }

    .history-item:hover .history-item-actions {
      opacity: 1;
    }

    .download-btn {
      width: 28px;
      height: 28px;
      padding: 4px;
      background: none;
      border: none;
      color: var(--primary-color);
      border-radius: var(--border-radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background var(--transition);
    }

    .download-btn:hover {
      background: #e8f5ff;
    }

    /* Upload zone */
    h2 {
      margin-bottom: 20px;
    }

    .drop-zone {
      width: 100%;
      max-width: 500px;
      padding: 40px;
      background: white;
      border: 2px dashed #ccc;
      text-align: center;
      cursor: pointer;
      transition: all var(--transition);
    }

    .drop-zone.dragover {
      background: #e8f5ff;
      border-color: var(--primary-color);
    }

    /* File list and items */
    .file-list {
      width: 100%;
      max-width: 500px;
      margin-top: 20px;
    }

    .file-item {
      background: white;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }

    .file-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    /* Progress indicators */
    .progress-container {
      background-color: #eee;
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .progress-bar {
      height: 20px;
      width: 0%;
      background-color: var(--success-color);
      color: white;
      text-align: center;
      line-height: 20px;
      font-size: 12px;
      transition: width var(--transition);
    }

    /* Preview components */
    .preview-img,
    .file-ext-preview {
      width: 100px;
      height: 100px;
      margin: 5px 0;
      border-radius: var(--border-radius);
      border: 2px solid var(--text-color);
    }

    .preview-img {
      object-fit: cover;
    }

    .file-ext-preview,
    .history-ext-preview {
      background: var(--preview-bg);
      color: white;
      font-weight: bold;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .file-ext-preview {
      font-size: 24px;
    }

    /* Common button styles */
    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1rem;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background var(--transition);
    }

    button:hover {
      background: var(--primary-hover);
    }
  </style>
</head>

<body>

  <div class="drop-overlay" id="dropOverlay">
    Drop files anywhere to upload
  </div>

  <div class="container">
    <div class="upload-section">

      <h2>Drag & Drop File Upload</h2>

      <form id="uploadForm">
        <div class="drop-zone" id="dropZone">
          Drag and drop files here or click to select
          <input type="file" id="fileInput" name="files" multiple style="display: none;" />
        </div>
        <button type="submit">Upload</button>
        <hr color="#e0e0e0" style="margin: 1em;"/> 
        <div class="file-list" id="fileList"></div>
      </form>
    </div>

    <div class="history-toggle" id="historyToggle" title="Toggle history panel">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M9 2l1 1L6.5 7.5 10 11l-1 1L4.5 7.5 9 2z" />
      </svg>
    </div>

    <div class="history-section">
      <h2>Upload History</h2>
      <div class="history-list" id="historyList"></div>
    </div>
  </div>


<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const form = document.getElementById('uploadForm');
    const dropOverlay = document.getElementById('dropOverlay');
    const historyToggle = document.getElementById('historyToggle');
    const container = document.querySelector('.container');
    let filesToUpload = [];

    // Toggle history panel
    historyToggle.addEventListener('click', () => {
      container.classList.toggle('show-history');
      // Save preference
      localStorage.setItem('showHistory', container.classList.contains('show-history'));
    });

    // Restore history panel state
    if (localStorage.getItem('showHistory') === 'true') {
      container.classList.add('show-history');
    }

    dropZone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    // Global drag and drop
    document.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropOverlay.classList.add('active');
    });

    document.addEventListener('dragleave', (e) => {
      if (!e.relatedTarget) {
        dropOverlay.classList.remove('active');
      }
    });

    document.addEventListener('drop', (e) => {
      e.preventDefault();
      dropOverlay.classList.remove('active');
      handleFiles(e.dataTransfer.files);
    });

    function getFileExtension(filename) {
      return filename.split('.').pop().toUpperCase();
    }

    function createPreview(file) {
      if (file.type.startsWith('image/')) {
        const preview = document.createElement('img');
        preview.className = 'preview-img';
        preview.loading = 'lazy';
        preview.width = 100;
        preview.height = 100;
        const reader = new FileReader();
       //reader.onload = e => preview.src = e.target.result;
        reader.onload = e => {
          // Create an off-screen canvas to resize the image
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const img = new Image();
          
          img.onload = () => {
            // Calculate size to maintain aspect ratio within 100x100
            const scale = Math.min(100 / img.width, 100 / img.height);
            canvas.width = 100;
            canvas.height = 100;
            
            // Fill background
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Center the image
            const scaledWidth = img.width * scale;
            const scaledHeight = img.height * scale;
            const x = (100 - scaledWidth) / 2;
            const y = (100 - scaledHeight) / 2;
            
            // Draw scaled image
            ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
            
            // Convert to WebP if supported
            preview.src = canvas.toDataURL('image/webp', 0.8) || canvas.toDataURL('image/jpeg', 0.8);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
        return preview;
      } else {
        const preview = document.createElement('div');
        preview.className = 'file-ext-preview';
        preview.textContent = getFileExtension(file.name);
        return preview;
      }
    }

    function handleFiles(fileListObj) {
      filesToUpload = [...fileListObj];
      fileList.innerHTML = '';

      filesToUpload.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'file-item';

        const name = document.createElement('div');
        name.className = 'file-name';
        name.textContent = file.name;

        const preview = createPreview(file);

        const container = document.createElement('div');
        container.className = 'progress-container';

        const bar = document.createElement('div');
        bar.className = 'progress-bar';
        container.appendChild(bar);

        item.appendChild(name);
        item.appendChild(preview);
        item.appendChild(container);
        fileList.appendChild(item);

        file.progressBar = bar;
      });
    }

    // Upload a single file
    function uploadFile(file) {
      return new Promise((resolve, reject) => {
        const formData = new FormData();
        formData.append('files', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/upload');
        xhr.setRequestHeader('Accept', 'application/json');

        xhr.upload.addEventListener('progress', (e) => {
          if (!e.lengthComputable) return;
          const percent = Math.round((e.loaded / e.total) * 100);
          file.progressBar.style.width = percent + '%';
          file.progressBar.textContent = percent + '%';
        });

        xhr.onload = () => {
          try {
            const response = JSON.parse(xhr.responseText);
            if (xhr.status === 200) {
              file.progressBar.style.backgroundColor = '#28a745';
              file.progressBar.textContent = '✅ Success';
              resolve(response);
            } else {
              const errorMsg = response.error || 'Upload failed';
              file.progressBar.style.backgroundColor = '#dc3545';
              file.progressBar.textContent = `❌ ${errorMsg}`;
              reject(new Error(errorMsg));
            }
          } catch (e) {
            if (xhr.status === 200) {
              file.progressBar.style.backgroundColor = '#28a745';
              file.progressBar.textContent = '✅ Success';
              resolve({ message: xhr.responseText });
            } else {
              file.progressBar.style.backgroundColor = '#dc3545';
              file.progressBar.textContent = `❌ ${xhr.responseText || 'Upload failed'}`;
              reject(new Error(xhr.responseText || 'Upload failed'));
            }
          }
        };

        xhr.onerror = () => {
          file.progressBar.style.backgroundColor = '#dc3545';
          file.progressBar.textContent = '❌ Network error';
          reject(new Error('Network error'));
        };

        xhr.send(formData);
      });
    }

    // Get file preview element
    function getFilePreview(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'webp'];

      if (imageExts.includes(ext)) {
        return `<img src="/uploads/${filename}" width="42" height="42" loading="lazy" onerror="this.outerHTML='<div class=\\'history-ext-preview\\'>${ext.toUpperCase()}</div>'" alt="">`;
      }

      return `<div class="history-ext-preview">${ext.toUpperCase()}</div>`;
    }

    // Format file size
    function formatFileSize(bytes) {
      const units = ['B', 'KB', 'MB', 'GB'];
      let size = bytes;
      let unitIndex = 0;

      while (size >= 1024 && unitIndex < units.length - 1) {
        size /= 1024;
        unitIndex++;
      }

      return `${size.toFixed(1)} ${units[unitIndex]}`;
    }

    // Download file
    function downloadFile(filename) {
      const link = document.createElement('a');
      link.href = `/uploads/${filename}`;
      link.download = filename; // This will force download instead of navigation
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Update history list
    async function updateHistory() {
      const historyList = document.getElementById('historyList');

      try {
        const response = await fetch('/uploads');
        const files = await response.json();

        historyList.innerHTML = files.map(file => `
          <div class="history-item">
            ${getFilePreview(file.name)}
            <div class="history-item-info">
              <p class="history-item-name" title="${file.name}">${file.name}</p>
              <p class="history-item-time">
                ${formatFileSize(file.size)} • ${new Date(file.time).toLocaleString()}
              </p>
            </div>
            <div class="history-item-actions">
              <button class="download-btn" onclick="downloadFile('${file.name}')" title="Download file">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M8 12l-4-4h2.5V3h3v5H12L8 12z"/>
                  <path d="M2 13h12v2H2z"/>
                </svg>
              </button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error fetching history:', error);
        historyList.innerHTML = '<p>Error loading history</p>';
      }
    }

    // Initial history load
    updateHistory();

    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      if (filesToUpload.length === 0) return;

      const uploadButton = this.querySelector('button');
      uploadButton.disabled = true;
      uploadButton.textContent = 'Uploading...';

      try {
        // Upload all files in parallel
        await Promise.allSettled(filesToUpload.map(file => uploadFile(file)));
        uploadButton.textContent = 'Upload Complete';
        // Update history after successful upload
        updateHistory();
      } catch (error) {
        console.error('Upload error:', error);
      } finally {
        uploadButton.disabled = false;
        setTimeout(() => {
          uploadButton.textContent = 'Upload';
        }, 2000);
      }
    });
  </script>
</body>

</html>